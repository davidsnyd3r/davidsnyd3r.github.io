<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Region Visualization</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        
        /* Fullscreen modal */
        #fullscreen-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #0f0a1f;
            z-index: 9999;
        }
        
        #fullscreen-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #fullscreen-viz {
            width: 100%;
            height: 100%;
        }
        
        .exit-fullscreen-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            padding: 0;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .exit-fullscreen-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
        
        /* Animated gradient background */
        .gradient-bg {
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 25%, #1e1b4b 50%, #7c3aed 75%, #1e1b4b 100%);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .glow-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(100px);
            animation: float 20s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
        }
        .slider {
            -webkit-appearance: none;
            appearance: none;
            height: 4px;
            border-radius: 2px;
            outline: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #8b5cf6;
            cursor: pointer;
        }
        .slider::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #8b5cf6;
            cursor: pointer;
            border: none;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 36px;
            height: 20px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4b5563;
            transition: .2s;
            border-radius: 20px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 12px;
            width: 12px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .2s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #8b5cf6;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(16px);
        }
    </style>
</head>
<body class="bg-gray-950 gradient-bg">
    <!-- Fullscreen Modal -->
    <div id="fullscreen-modal">
        <button class="exit-fullscreen-btn" onclick="exitFullscreen()" title="Exit Fullscreen (ESC)">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="pointer-events: none;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
        <svg id="fullscreen-viz" viewBox="0 0 900 600" style="cursor: grab;">
            <defs>
                <radialGradient id="bgGrad2">
                    <stop offset="0%" stop-color="#1e1b4b" stop-opacity="0.8"/>
                    <stop offset="100%" stop-color="#0f0a1f" stop-opacity="1"/>
                </radialGradient>
            </defs>
            <rect width="900" height="600" fill="url(#bgGrad2)"/>
            <g id="fullscreen-group" transform="translate(450,300)"></g>
        </svg>
    </div>
    
    <!-- Animated orbs for depth -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="glow-orb w-96 h-96 bg-purple-600/20 -top-48 -left-48"></div>
        <div class="glow-orb w-96 h-96 bg-blue-600/20 -bottom-48 -right-48" style="animation-delay: 5s;"></div>
        <div class="glow-orb w-64 h-64 bg-violet-600/20 top-1/2 left-1/2" style="animation-delay: 10s;"></div>
    </div>
    
    <div id="app" class="min-h-screen flex flex-col relative z-10">
        <!-- Header -->
        <div class="border-b border-white/10 bg-gray-900/50 backdrop-blur-xl">
            <div class="max-w-7xl mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-semibold text-white tracking-tight">Constraint Region Explorer</h1>
                        <p class="text-sm text-gray-300/80 mt-0.5">3D visualization of constrained lattice points in ℝ³</p>
                    </div>
                    <div class="flex gap-2">
                        <button id="fullscreen-btn" onclick="toggleFullscreen()" class="px-3 py-2 bg-white/10 hover:bg-white/20 text-white border border-white/20 rounded-lg transition-all backdrop-blur-sm">
                            <svg id="fullscreen-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                            </svg>
                        </button>
                        <button onclick="resetView()" class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white border border-white/20 rounded-lg transition-all backdrop-blur-sm">
                            Reset View
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 max-w-7xl mx-auto w-full p-6">
            <div class="grid grid-cols-1 lg:grid-cols-[1fr,360px] gap-6 h-full">
                <!-- Visualization -->
                <div class="bg-white/5 backdrop-blur-md rounded-2xl border border-white/10 p-4 shadow-2xl">
                    <svg id="viz" class="w-full h-full rounded-lg" viewBox="0 0 900 600" style="cursor: grab; background: linear-gradient(145deg, #0f0a1f 0%, #1e1b4b 100%);">
                        <defs>
                            <radialGradient id="bgGrad">
                                <stop offset="0%" stop-color="#1e1b4b" stop-opacity="0.8"/>
                                <stop offset="100%" stop-color="#0f0a1f" stop-opacity="1"/>
                            </radialGradient>
                        </defs>
                        <rect width="900" height="600" fill="url(#bgGrad)"/>
                        <g id="main-group" transform="translate(450,300)"></g>
                    </svg>
                </div>

                <!-- Controls -->
                <div class="space-y-4 overflow-y-auto">
                    <!-- View Controls -->
                    <div class="bg-white/5 backdrop-blur-md rounded-xl border border-white/10 p-4 shadow-xl">
                        <h3 class="text-xs font-semibold text-gray-300 uppercase tracking-wider mb-4">View Controls</h3>
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-gray-400">Rotation</span>
                                    <span class="text-gray-300 font-mono" id="rotation-value">-224°</span>
                                </div>
                                <input type="range" id="rotation" min="-360" max="360" value="-224" class="slider w-full bg-gray-700">
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-gray-400">Elevation</span>
                                    <span class="text-gray-300 font-mono" id="elevation-value">12°</span>
                                </div>
                                <input type="range" id="elevation" min="-90" max="90" value="12" class="slider w-full bg-gray-700">
                            </div>
                            <div>
                                <div class="flex justify-between text-xs mb-1">
                                    <span class="text-gray-400">Zoom</span>
                                    <span class="text-gray-300 font-mono" id="zoom-value">1.0×</span>
                                </div>
                                <input type="range" id="zoom" min="0.5" max="3" step="0.1" value="1" class="slider w-full bg-gray-700">
                            </div>
                        </div>
                    </div>

                    <!-- Data Layers -->
                    <div class="bg-white/5 backdrop-blur-md rounded-xl border border-white/10 p-4 shadow-xl">
                        <h3 class="text-xs font-semibold text-gray-300 uppercase tracking-wider mb-4">Data Layers</h3>
                        <div class="space-y-2">
                            <label class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-violet-500"></div>
                                    <span class="text-sm text-gray-300">Left Tube</span>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="show-left" checked>
                                    <span class="toggle-slider"></span>
                                </div>
                            </label>
                            <label class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-emerald-500"></div>
                                    <span class="text-sm text-gray-300">Right Tube</span>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="show-right" checked>
                                    <span class="toggle-slider"></span>
                                </div>
                            </label>
                            <label class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                                    <span class="text-sm text-gray-300">Central Tube</span>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="show-central" checked>
                                    <span class="toggle-slider"></span>
                                </div>
                            </label>
                            <label class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-amber-500"></div>
                                    <span class="text-sm text-gray-300">Radical Vector</span>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="show-radical" checked>
                                    <span class="toggle-slider"></span>
                                </div>
                            </label>
                            <label class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-gray-500"></div>
                                    <span class="text-sm text-gray-300">Root Points</span>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="show-roots" checked>
                                    <span class="toggle-slider"></span>
                                </div>
                            </label>
                            <label class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full bg-pink-500"></div>
                                    <span class="text-sm text-gray-300">Missing Points</span>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="show-missing">
                                    <span class="toggle-slider"></span>
                                </div>
                            </label>
                            <label class="flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <span class="text-red-500">★</span>
                                    <span class="text-sm text-gray-300">Invalid Points</span>
                                </div>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="show-invalid">
                                    <span class="toggle-slider"></span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Display Options -->
                    <div class="bg-white/5 backdrop-blur-md rounded-xl border border-white/10 p-4 shadow-xl">
                        <h3 class="text-xs font-semibold text-gray-300 uppercase tracking-wider mb-4">Display</h3>
                        <div class="space-y-2">
                            <label class="flex items-center justify-between">
                                <span class="text-sm text-gray-300">Axes</span>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="show-axes" checked>
                                    <span class="toggle-slider"></span>
                                </div>
                            </label>
                            <label class="flex items-center justify-between">
                                <span class="text-sm text-gray-300">Grid</span>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="show-grid">
                                    <span class="toggle-slider"></span>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Transformations/Iterations - ALL CHECKED BY DEFAULT -->
                    <div class="bg-white/5 backdrop-blur-md rounded-xl border border-white/10 p-4 shadow-xl">
                        <h3 class="text-xs font-semibold text-gray-300 uppercase tracking-wider mb-4">Transformations</h3>
                        <div class="space-y-2">
                            <label class="flex items-center justify-between">
                                <span class="text-sm text-gray-300 font-mono">T¹ (+2, +4, +2)</span>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="show-iter1" checked>
                                    <span class="toggle-slider"></span>
                                </div>
                            </label>
                            <label class="flex items-center justify-between">
                                <span class="text-sm text-gray-300 font-mono">T² (+4, +8, +4)</span>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="show-iter2" checked>
                                    <span class="toggle-slider"></span>
                                </div>
                            </label>
                            <label class="flex items-center justify-between">
                                <span class="text-sm text-gray-300 font-mono">T³ (+6, +12, +6)</span>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="show-iter3" checked>
                                    <span class="toggle-slider"></span>
                                </div>
                            </label>
                            <label class="flex items-center justify-between">
                                <span class="text-sm text-gray-300 font-mono">T⁴ (+8, +16, +8)</span>
                                <div class="toggle-switch">
                                    <input type="checkbox" id="show-iter4" checked>
                                    <span class="toggle-slider"></span>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // State variables - WITH YOUR DEFAULTS
        let rotation = -224;
        let elevation = 12;
        let zoom = 1;
        let isDragging = false;
        let lastMouse = { x: 0, y: 0 };

        // Point data
        const points = {
            right: [[0, 3, 3], [1, 3, 3], [2, 4, 3]],
            left: [[3, 3, 0], [3, 3, 1], [3, 4, 2]],
            central: [[0, 3, 0], [2, 6, 2], [2, 5, 2]],
            radical: [[2, 4, 2]],
            missing: [[0,0,0],[1,4,3],[3,4,1],[3,8,5],[5,8,3]],
            invalid: [[2,4,4],[0,4,2],[2,4,0],[4,4,2]],
            roots: [
                [0,1,0],[0,1,1],[0,2,1],[1,1,0],[0,2,0],
                [0,2,2],[1,2,0],[1,1,1],[0,3,2],
                [1,3,0],[1,2,2],[1,3,2],[0,3,1],[1,2,1],
                [1,3,1],[1,4,1],[1,4,2],[1,5,2],[1,5,1],
                [1,5,3],[2,4,1],[3,5,1],[2,5,4],
                [2,3,2],[2,3,1],[2,2,1],[2,3,3],[2,2,2],
                [2,3,0],[2,2,0],[4,5,4],[4,5,2],
                [3,5,4],[4,5,3],[3,4,3],[3,3,2],
                [3,3,3],[2,5,1]
            ]
        };

        // Colors
        const colors = {
            left: '#8b5cf6',
            right: '#10b981',
            central: '#3b82f6',
            radical: '#f59e0b',
            roots: '#6b7280',
            missing: '#ec4899',
            invalid: '#ef4444'
        };

        // Check constraints
        function satisfiesConstraints(x, y, z) {
            if (x < 0 || z < 0 || y < 0) return false;
            if (y < x || y < z) return false;
            if (Math.abs(z - x) > 2) return false;
            if (Math.abs(y - x - z) > 3) return false;
            if (Math.abs(y - 2*x) > 3) return false;
            if (Math.abs(y - 2*z) > 3) return false;
            return true;
        }

        // 3D to 2D projection
        function project(x, y, z) {
            const angleRad = (rotation * Math.PI) / 180;
            const elevationRad = (elevation * Math.PI) / 180;
            
            // Center the coordinate system
            const xCentered = x - 2.5;
            const yCentered = y - 6;
            const zCentered = z - 2.5;
            
            const xRotated = xCentered * Math.cos(angleRad) - zCentered * Math.sin(angleRad);
            const zRotated = xCentered * Math.sin(angleRad) + zCentered * Math.cos(angleRad);
            const yRotated = yCentered * Math.cos(elevationRad) - zRotated * Math.sin(elevationRad);
            
            const scale = 30 * zoom;
            return {
                x: xRotated * scale,
                y: -yRotated * scale
            };
        }

        // Transform point for iterations
        function transformPoint(point, iter) {
            return [
                point[0] + 2 * iter,
                point[1] + 4 * iter,
                point[2] + 2 * iter
            ];
        }

        // Draw function
        function draw(targetGroup = null) {
            const g = targetGroup || document.getElementById('main-group');
            g.innerHTML = '';
            
            // Draw grid
            if (document.getElementById('show-grid').checked) {
                for (let i = 0; i <= 10; i += 2) {
                    const line1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    const p1 = project(i, 0, 0);
                    const p2 = project(i, 0, 10);
                    line1.setAttribute('x1', p1.x);
                    line1.setAttribute('y1', p1.y);
                    line1.setAttribute('x2', p2.x);
                    line1.setAttribute('y2', p2.y);
                    line1.setAttribute('stroke', '#374151');
                    line1.setAttribute('stroke-width', '0.5');
                    line1.setAttribute('opacity', '0.3');
                    g.appendChild(line1);
                    
                    const line2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    const p3 = project(0, 0, i);
                    const p4 = project(10, 0, i);
                    line2.setAttribute('x1', p3.x);
                    line2.setAttribute('y1', p3.y);
                    line2.setAttribute('x2', p4.x);
                    line2.setAttribute('y2', p4.y);
                    line2.setAttribute('stroke', '#374151');
                    line2.setAttribute('stroke-width', '0.5');
                    line2.setAttribute('opacity', '0.3');
                    g.appendChild(line2);
                }
            }
            
            // Draw axes
            if (document.getElementById('show-axes').checked) {
                const axes = [
                    { start: [0,0,0], end: [8,0,0], color: '#ef4444', label: 'x' },
                    { start: [0,0,0], end: [0,15,0], color: '#22c55e', label: 'y' },
                    { start: [0,0,0], end: [0,0,8], color: '#3b82f6', label: 'z' }
                ];
                
                axes.forEach(axis => {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    const start = project(...axis.start);
                    const end = project(...axis.end);
                    line.setAttribute('x1', start.x);
                    line.setAttribute('y1', start.y);
                    line.setAttribute('x2', end.x);
                    line.setAttribute('y2', end.y);
                    line.setAttribute('stroke', axis.color);
                    line.setAttribute('stroke-width', '2');
                    line.setAttribute('opacity', '0.6');
                    g.appendChild(line);
                    
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', end.x + 10);
                    text.setAttribute('y', end.y + 5);
                    text.setAttribute('fill', axis.color);
                    text.setAttribute('font-size', '14');
                    text.setAttribute('font-weight', '600');
                    text.textContent = axis.label;
                    g.appendChild(text);
                });
            }
            
            // Draw points
            function drawPoint(point, color, opacity = 1, radius = 5) {
                const p = project(...point);
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', p.x);
                circle.setAttribute('cy', p.y);
                circle.setAttribute('r', radius);
                circle.setAttribute('fill', color);
                circle.setAttribute('fill-opacity', opacity);
                circle.setAttribute('stroke', '#fff');
                circle.setAttribute('stroke-width', '0.5');
                circle.setAttribute('stroke-opacity', opacity * 0.3);
                g.appendChild(circle);
            }
            
            // Draw star for invalid points
            function drawStar(point, opacity = 1, size = 7) {
                const p = project(...point);
                const star = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
                const pts = [];
                for (let i = 0; i < 10; i++) {
                    const radius = i % 2 === 0 ? size : size/2;
                    const angle = (Math.PI / 5) * i - Math.PI / 2;
                    pts.push(`${p.x + radius * Math.cos(angle)},${p.y + radius * Math.sin(angle)}`);
                }
                star.setAttribute('points', pts.join(' '));
                star.setAttribute('fill', colors.invalid);
                star.setAttribute('fill-opacity', opacity);
                star.setAttribute('stroke', '#fff');
                star.setAttribute('stroke-width', '0.5');
                star.setAttribute('stroke-opacity', opacity * 0.3);
                g.appendChild(star);
            }
            
            // Filter special points from roots
            const isSpecialPoint = (point) => {
                const allSpecial = [...points.right, ...points.left, ...points.central, ...points.radical];
                return allSpecial.some(sp => sp[0] === point[0] && sp[1] === point[1] && sp[2] === point[2]);
            };
            
            const rootPoints = points.roots.filter(point => !isSpecialPoint(point));
            
            // Draw base points (iteration 0)
            if (document.getElementById('show-left').checked) {
                points.left.filter(p => satisfiesConstraints(...p)).forEach(p => 
                    drawPoint(p, colors.left));
            }
            
            if (document.getElementById('show-right').checked) {
                points.right.filter(p => satisfiesConstraints(...p)).forEach(p => 
                    drawPoint(p, colors.right));
            }
            
            if (document.getElementById('show-central').checked) {
                points.central.filter(p => satisfiesConstraints(...p)).forEach(p => 
                    drawPoint(p, colors.central));
            }
            
            if (document.getElementById('show-radical').checked) {
                points.radical.filter(p => satisfiesConstraints(...p)).forEach(p => 
                    drawPoint(p, colors.radical));
            }
            
            if (document.getElementById('show-roots').checked) {
                rootPoints.forEach(p => drawPoint(p, colors.roots));
            }
            
            if (document.getElementById('show-missing').checked) {
                points.missing.forEach(p => drawPoint(p, colors.missing));
            }
            
            if (document.getElementById('show-invalid').checked) {
                points.invalid.forEach(p => drawStar(p));
                [...points.left, ...points.right, ...points.central, ...points.radical]
                    .filter(p => !satisfiesConstraints(...p))
                    .forEach(p => drawStar(p));
            }
            
            // Draw iterations
            for (let iter = 1; iter <= 4; iter++) {
                const checkbox = document.getElementById(`show-iter${iter}`);
                if (!checkbox || !checkbox.checked) continue;
                
                // Calculate opacity and size based on iteration
                const opacity = Math.max(0.3, 1 - iter * 0.15);
                const radius = Math.max(3, 5 - iter * 0.5);
                const starSize = Math.max(4, 7 - iter);
                
                // Transform and draw valid points
                if (document.getElementById('show-left').checked) {
                    points.left.filter(p => satisfiesConstraints(...p)).forEach(p => {
                        const tp = transformPoint(p, iter);
                        if (satisfiesConstraints(...tp) && tp[1] <= 30) {
                            drawPoint(tp, colors.left, opacity, radius);
                        }
                    });
                }
                
                if (document.getElementById('show-right').checked) {
                    points.right.filter(p => satisfiesConstraints(...p)).forEach(p => {
                        const tp = transformPoint(p, iter);
                        if (satisfiesConstraints(...tp) && tp[1] <= 30) {
                            drawPoint(tp, colors.right, opacity, radius);
                        }
                    });
                }
                
                if (document.getElementById('show-central').checked) {
                    points.central.filter(p => satisfiesConstraints(...p)).forEach(p => {
                        const tp = transformPoint(p, iter);
                        if (satisfiesConstraints(...tp) && tp[1] <= 30) {
                            drawPoint(tp, colors.central, opacity, radius);
                        }
                    });
                }
                
                if (document.getElementById('show-radical').checked) {
                    points.radical.filter(p => satisfiesConstraints(...p)).forEach(p => {
                        const tp = transformPoint(p, iter);
                        if (satisfiesConstraints(...tp) && tp[1] <= 30) {
                            drawPoint(tp, colors.radical, opacity, radius);
                        }
                    });
                }
                
                if (document.getElementById('show-roots').checked) {
                    rootPoints.forEach(p => {
                        const tp = transformPoint(p, iter);
                        if (satisfiesConstraints(...tp) && tp[1] <= 30) {
                            drawPoint(tp, colors.roots, opacity, radius);
                        }
                    });
                }
                
                if (document.getElementById('show-missing').checked) {
                    points.missing.forEach(p => {
                        const tp = transformPoint(p, iter);
                        if (satisfiesConstraints(...tp) && tp[1] <= 30) {
                            drawPoint(tp, colors.missing, opacity, radius);
                        }
                    });
                }
                
                // Transform and draw invalid points (no constraint check)
                if (document.getElementById('show-invalid').checked) {
                    [...points.invalid,
                     ...points.left.filter(p => !satisfiesConstraints(...p)),
                     ...points.right.filter(p => !satisfiesConstraints(...p)),
                     ...points.central.filter(p => !satisfiesConstraints(...p)),
                     ...points.radical.filter(p => !satisfiesConstraints(...p))]
                    .forEach(p => {
                        const tp = transformPoint(p, iter);
                        if (tp[1] <= 30) {
                            drawStar(tp, opacity, starSize);
                        }
                    });
                }
            }
        }

        // Event handlers
        document.getElementById('rotation').addEventListener('input', (e) => {
            rotation = parseInt(e.target.value);
            const rotValue = document.getElementById('rotation-value');
            if (rotValue) rotValue.textContent = rotation + '°';
            draw();
        });

        document.getElementById('elevation').addEventListener('input', (e) => {
            elevation = parseInt(e.target.value);
            const elevValue = document.getElementById('elevation-value');
            if (elevValue) elevValue.textContent = elevation + '°';
            draw();
        });

        document.getElementById('zoom').addEventListener('input', (e) => {
            zoom = parseFloat(e.target.value);
            const zoomValue = document.getElementById('zoom-value');
            if (zoomValue) zoomValue.textContent = zoom.toFixed(1) + '×';
            draw();
        });

        // Checkboxes
        ['show-left', 'show-right', 'show-central', 'show-radical', 'show-roots', 'show-missing', 'show-invalid', 
         'show-axes', 'show-grid', 'show-iter1', 'show-iter2', 'show-iter3', 'show-iter4'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', draw);
            }
        });

        // Mouse controls
        const svg = document.getElementById('viz');
        
        svg.addEventListener('mousedown', (e) => {
            isDragging = true;
            lastMouse = { x: e.clientX, y: e.clientY };
            svg.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const deltaX = e.clientX - lastMouse.x;
            const deltaY = e.clientY - lastMouse.y;
            
            rotation = (rotation + deltaX * 0.5) % 360;
            elevation = Math.max(-90, Math.min(90, elevation - deltaY * 0.5));
            
            const rotSlider = document.getElementById('rotation');
            const elevSlider = document.getElementById('elevation');
            const rotValue = document.getElementById('rotation-value');
            const elevValue = document.getElementById('elevation-value');
            
            if (rotSlider) rotSlider.value = rotation;
            if (elevSlider) elevSlider.value = elevation;
            if (rotValue) rotValue.textContent = Math.round(rotation) + '°';
            if (elevValue) elevValue.textContent = Math.round(elevation) + '°';
            
            lastMouse = { x: e.clientX, y: e.clientY };
            
            // Draw in both containers if fullscreen is active
            const modal = document.getElementById('fullscreen-modal');
            if (modal.classList.contains('active')) {
                draw(document.getElementById('fullscreen-group'));
            }
            draw();
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            svg.style.cursor = 'grab';
            const fullscreenSvg = document.getElementById('fullscreen-viz');
            if (fullscreenSvg) fullscreenSvg.style.cursor = 'grab';
        });

        svg.addEventListener('wheel', (e) => {
            e.preventDefault();
            zoom = Math.max(0.5, Math.min(3, zoom + (e.deltaY > 0 ? -0.1 : 0.1)));
            const zoomSlider = document.getElementById('zoom');
            const zoomValue = document.getElementById('zoom-value');
            if (zoomSlider) zoomSlider.value = zoom;
            if (zoomValue) zoomValue.textContent = zoom.toFixed(1) + '×';
            draw();
        });

        // Reset view - WITH YOUR DEFAULTS
        function resetView() {
            rotation = -224;
            elevation = 12;
            zoom = 1;
            
            const rotSlider = document.getElementById('rotation');
            const elevSlider = document.getElementById('elevation');
            const zoomSlider = document.getElementById('zoom');
            const rotValue = document.getElementById('rotation-value');
            const elevValue = document.getElementById('elevation-value');
            const zoomValue = document.getElementById('zoom-value');
            
            if (rotSlider) rotSlider.value = rotation;
            if (elevSlider) elevSlider.value = elevation;
            if (zoomSlider) zoomSlider.value = zoom;
            if (rotValue) rotValue.textContent = rotation + '°';
            if (elevValue) elevValue.textContent = elevation + '°';
            if (zoomValue) zoomValue.textContent = zoom.toFixed(1) + '×';
            
            draw();
        }

        // Fullscreen with graph only
        function toggleFullscreen() {
            const modal = document.getElementById('fullscreen-modal');
            modal.classList.add('active');
            
            // Draw the visualization in the fullscreen container
            draw(document.getElementById('fullscreen-group'));
            
            // Set up mouse controls for fullscreen viz
            const fullscreenSvg = document.getElementById('fullscreen-viz');
            
            fullscreenSvg.addEventListener('mousedown', (e) => {
                isDragging = true;
                lastMouse = { x: e.clientX, y: e.clientY };
                fullscreenSvg.style.cursor = 'grabbing';
            });
            
            fullscreenSvg.addEventListener('wheel', (e) => {
                e.preventDefault();
                zoom = Math.max(0.5, Math.min(3, zoom + (e.deltaY > 0 ? -0.1 : 0.1)));
                const zoomSlider = document.getElementById('zoom');
                const zoomValue = document.getElementById('zoom-value');
                if (zoomSlider) zoomSlider.value = zoom;
                if (zoomValue) zoomValue.textContent = zoom.toFixed(1) + '×';
                draw(document.getElementById('fullscreen-group'));
            });
        }
        
        function exitFullscreen() {
            const modal = document.getElementById('fullscreen-modal');
            modal.classList.remove('active');
            
            // Redraw in the main container
            draw();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'f' || e.key === 'F') {
                const modal = document.getElementById('fullscreen-modal');
                if (!modal.classList.contains('active')) {
                    toggleFullscreen();
                }
            } else if (e.key === 'Escape') {
                const modal = document.getElementById('fullscreen-modal');
                if (modal.classList.contains('active')) {
                    exitFullscreen();
                }
            } else if (e.key === 'r' || e.key === 'R') {
                resetView();
            }
        });

        // Initial draw
        draw();
    </script>
</body>
</html>
